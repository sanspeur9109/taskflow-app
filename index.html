.todo-title-container {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
        }

        .expand-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .expand-spacer {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .subtask-count {
            color: #666;
            font-size: 0.9rem;
            font-weight: 500;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .subtask-level-1 {
            margin-left: 30px;
            border-left: 2px solid #e0e0e0;
            background: #fafafa;
        }

        .subtask-level-2 {
            margin-left: 60px;
            border-left: 2px solid #e0e0e0;
            background: #f5f5f5;
        }

        .subtask-level-3 {
            margin-left: 90px;
            border-left: 2px solid #e0e0e0;
            background: #f0f0f0;
        }

        .todo-action.add-subtask {
            background: #17a2b8;
            color: white;
        }

        .todo-action.add-subtask:hover {
            background: #138496;
        }

        /* Enhanced subtask styling */
        .subtask-level-1 .todo-item {
            border-radius: 8px;
        }

        .subtask-level-2 .todo-item {
            border-radius: 6px;
        }

        .subtask-level-3 .todo-item {
            border-radius: 4px;
        }

        /* Mobile responsive adjustments for subtasks */
        @media (max-width: 768px) {
            .subtask-level-1 {
                margin-left: 20px;
            }

            .subtask-level-2 {
                margin-left: 40px;
            }

            .subtask-level-3 {
                margin-left: 60px;
            }

            .todo-title-container {
                flex-direction: row;
                align-items: center;
            }

            .expand-btn {
                width: 20px;
                height: 20px;
                font-size: 0.8rem;
            }

            .expand-spacer {
                width: 20px;
                height: 20px;
            }
        }

        /* Drag and drop for subtasks */
        .todo-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .todo-item.drag-over {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            border-left-color: #2196f3;
        }

        /* Progress indicators for parent tasks */
        /* Subtask Modal Styles */
        .subtask-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .subtask-modal {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .subtask-modal h3 {
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .subtask-indicator {
            background: #e8f4fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .parent-progress {
            margin-top: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            height: 6px;
            overflow: hidden;
        }

        .parent-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .parent-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 4px;
        }<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TaskFlow">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxODAiIGhlaWdodD0iMTgwIiByeD0iNDAiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcl8xXzEpIi8+CjxwYXRoIGQ9Ik00NSA5MEw3NSAxMjBMMTM1IDYwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyXzFfMSIgeDE9IjAiIHkxPSIwIiB4Mj0iMTgwIiB5Mj0iMTgwIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHN2Zz4K">
    <title>TaskFlow - Professional Todo Manager</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .form-group {
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }

        .main-app {
            display: none;
        }

        .main-app.active {
            display: block;
        }

        .app-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .sync-status.synced {
            background: #d4edda;
            color: #155724;
        }

        .sync-status.syncing {
            background: #fff3cd;
            color: #856404;
        }

        .controls {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .controls-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 20px;
        }

        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-upload input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-upload-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
        }

        .drag-drop-area {
            border: 3px dashed #ccc;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .drag-drop-area.drag-over {
            border-color: #667eea;
            background: #f0f4ff;
            transform: scale(1.02);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .todo-form {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .todos-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .todo-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            border-left: 4px solid #ccc;
            position: relative;
            overflow: hidden;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .todo-item.completed {
            opacity: 0.7;
            background: #e8f5e8;
        }

        .todo-item.completed .todo-title {
            text-decoration: line-through;
        }

        .todo-item.high-priority {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #fff5f5 0%, #f8f9fa 100%);
        }

        .todo-item.medium-priority {
            border-left-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #f8f9fa 100%);
        }

        .todo-item.low-priority {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #f0fff4 0%, #f8f9fa 100%);
        }

        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .todo-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .todo-actions {
            display: flex;
            gap: 8px;
        }

        .todo-action {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .todo-action.complete {
            background: #28a745;
            color: white;
        }

        .todo-action.edit {
            background: #007bff;
            color: white;
        }

        .todo-action.delete {
            background: #dc3545;
            color: white;
        }

        .todo-action:hover {
            transform: scale(1.1);
        }

        .todo-meta {
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 0.9rem;
            color: #666;
            margin-top: 10px;
        }

        .priority-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high {
            background: #ffebee;
            color: #c62828;
        }

        .priority-medium {
            background: #fff8e1;
            color: #f57c00;
        }

        .priority-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .category-badge {
            background: #e3f2fd;
            color: #1565c0;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .due-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .overdue {
            color: #dc3545;
            font-weight: 600;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ccc;
            margin-bottom: 20px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #333;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .app-header {
                padding: 20px;
                flex-direction: column;
                text-align: center;
            }

            .controls {
                padding: 20px;
            }

            .controls-row {
                flex-direction: column;
                align-items: stretch;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                justify-content: center;
            }

            .todo-header {
                flex-direction: column;
                gap: 10px;
            }

            .todo-actions {
                align-self: flex-end;
            }

            .todo-meta {
                flex-wrap: wrap;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .stats {
                grid-template-columns: 1fr;
            }

            .auth-container {
                padding: 20px;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .todo-item {
            animation: fadeInUp 0.5s ease;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><i class="fas fa-tasks"></i> TaskFlow</h1>
            <p>Professional Todo Management with Excel Integration</p>
        </div>

        <!-- Authentication -->
        <div id="auth-section" class="auth-container">
            <div class="auth-form">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Welcome to TaskFlow</h2>
                <div class="form-group">
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button class="btn btn-primary" onclick="handleAuth('login')">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <button class="btn btn-secondary" onclick="handleAuth('register')">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </div>
        </div>

        <!-- Main Application -->
        <div id="main-app" class="main-app">
            <!-- App Header -->
            <div class="app-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div>
                        <h3 id="user-name">Welcome User</h3>
                        <div class="sync-status synced">
                            <i class="fas fa-check-circle"></i>
                            <span>All devices synced</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-tasks">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completed-tasks">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pending-tasks">0</div>
                    <div class="stat-label">Pending</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overdue-tasks">0</div>
                    <div class="stat-label">Overdue</div>
                </div>
            </div>

            <!-- Controls -->
            <div class="controls">
                <!-- Excel Upload -->
                <div class="drag-drop-area" id="drop-area">
                    <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                    <h3>Drop Excel file here or click to upload</h3>
                    <p>Supports .xlsx, .xls files</p>
                    <div class="file-upload">
                        <input type="file" id="excel-file" accept=".xlsx,.xls" onchange="handleFileUpload(this)">
                        <label for="excel-file" class="file-upload-label">
                            <i class="fas fa-file-excel"></i>
                            Choose Excel File
                        </label>
                    </div>
                </div>

                <!-- Filters -->
                <div class="controls-row">
                    <div class="filter-controls">
                        <button class="filter-btn active" data-filter="all">All Tasks</button>
                        <button class="filter-btn" data-filter="pending">Pending</button>
                        <button class="filter-btn" data-filter="completed">Completed</button>
                        <button class="filter-btn" data-filter="high">High Priority</button>
                        <button class="filter-btn" data-filter="overdue">Overdue</button>
                    </div>
                </div>
            </div>

            <!-- Add Todo Form -->
            <div class="todo-form">
                <h3 style="margin-bottom: 20px; color: #333;">
                    <i class="fas fa-plus-circle"></i> Add New Task
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-title">Task Title</label>
                        <input type="text" id="task-title" placeholder="Enter task title">
                    </div>
                    <div class="form-group">
                        <label for="task-category">Category</label>
                        <select id="task-category">
                            <option value="work">Work</option>
                            <option value="personal">Personal</option>
                            <option value="shopping">Shopping</option>
                            <option value="health">Health</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="task-priority">Priority</label>
                        <select id="task-priority">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="task-due-date">Due Date</label>
                        <input type="date" id="task-due-date">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addTodo()">
                    <i class="fas fa-plus"></i> Add Task
                </button>
            </div>

            <!-- Todos List -->
            <div class="todos-container">
                <h3 style="margin-bottom: 20px; color: #333;">
                    <i class="fas fa-list"></i> Your Tasks
                </h3>
                <div id="todos-list">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>No tasks yet</h3>
                        <p>Add your first task or upload an Excel file to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Environment Configuration with Validation
        const ENV_CONFIG = {
            TAILSCALE_API_KEY: null,
            SYNC_ENDPOINT: null,
            ENCRYPTION_KEY: 'default-local-key-change-in-production'
        };

        // Validate environment variables
        function validateEnvironment() {
            const warnings = [];
            
            // Check if running in production-like environment
            const isProduction = window.location.protocol === 'https:' || 
                                window.location.hostname !== 'localhost';
            
            if (isProduction) {
                // In production, we would expect these to be set
                if (!ENV_CONFIG.TAILSCALE_API_KEY) {
                    warnings.push('TAILSCALE_API_KEY not configured - sync disabled');
                }
                if (!ENV_CONFIG.SYNC_ENDPOINT) {
                    warnings.push('SYNC_ENDPOINT not configured - using local storage only');
                }
            }
            
            // Log warnings for debugging
            warnings.forEach(warning => {
                console.warn('⚠️ Environment Warning:', warning);
            });
            
            return {
                isValid: true, // Don't break the app, just warn
                warnings,
                canSync: !!(ENV_CONFIG.TAILSCALE_API_KEY && ENV_CONFIG.SYNC_ENDPOINT)
            };
        }

        // Global State Management
        class TodoApp {
            constructor() {
                this.todos = [];
                this.currentUser = null;
                this.filter = 'all';
                this.envConfig = validateEnvironment();
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.loadUserData();
                
                if (!this.envConfig.canSync) {
                    console.log('📱 Running in offline mode - data stored locally');
                    this.updateSyncStatus('offline', 'Local storage only');
                }
            }

            setupEventListeners() {
                // File drag and drop
                const dropArea = document.getElementById('drop-area');
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.add('drag-over'), false);
                });

                ['dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, () => dropArea.classList.remove('drag-over'), false);
                });

                dropArea.addEventListener('drop', this.handleDrop.bind(this), false);
                dropArea.addEventListener('click', () => document.getElementById('excel-file').click());

                // Filter buttons
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.filter = e.target.dataset.filter;
                        this.renderTodos();
                    });
                });

                // Auto-sync every 30 seconds if enabled
                if (this.envConfig.canSync) {
                    setInterval(() => this.syncData(), 30000);
                }
            }

            preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            handleDrop(e) {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    this.handleFileUpload(files[0]);
                }
            }

            handleFileUpload(file) {
                if (!file) return;

                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel'
                ];

                if (!validTypes.includes(file.type)) {
                    this.showNotification('Please upload a valid Excel file (.xlsx or .xls)', 'error');
                    return;
                }

                this.showNotification('Processing Excel file...', 'warning');
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        this.parseExcelFile(e.target.result);
                    } catch (error) {
                        console.error('Excel parsing error:', error);
                        this.showNotification('Error parsing Excel file. Please check the format.', 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            parseExcelFile(data) {
                try {
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (jsonData.length < 2) {
                        this.showNotification('Excel file appears to be empty or has no data rows', 'error');
                        return;
                    }

                    const headers = jsonData[0].map(h => h.toString().toLowerCase().trim());
                    const rows = jsonData.slice(1);

                    // Intelligent column detection (including parent task detection)
                    const columnMap = this.detectColumns(headers);
                    
                    if (!columnMap.title) {
                        this.showNotification('Could not detect a title/task column in the Excel file', 'error');
                        return;
                    }

                    let importedCount = 0;
                    const errors = [];
                    const taskMap = new Map(); // For parent-child relationships

                    // First pass: Create all tasks
                    rows.forEach((row, index) => {
                        try {
                            if (!row[columnMap.title] || row[columnMap.title].toString().trim() === '') {
                                return; // Skip empty rows
                            }

                            const todo = {
                                id: this.generateId(),
                                title: row[columnMap.title].toString().trim(),
                                category: columnMap.category !== -1 ? 
                                    this.normalizeCategory(row[columnMap.category]) : 'other',
                                priority: columnMap.priority !== -1 ? 
                                    this.normalizePriority(row[columnMap.priority]) : 'medium',
                                dueDate: columnMap.dueDate !== -1 ? 
                                    this.parseDate(row[columnMap.dueDate]) : '',
                                completed: columnMap.status !== -1 ? 
                                    this.parseStatus(row[columnMap.status]) : false,
                                parentId: null,
                                subtasks: [],
                                isExpanded: true,
                                createdAt: new Date().toISOString(),
                                originalRowIndex: index
                            };

                            // Store for parent-child processing
                            taskMap.set(index, {
                                todo,
                                parentReference: columnMap.parent !== -1 ? row[columnMap.parent] : null
                            });

                            importedCount++;
                        } catch (error) {
                            errors.push(`Row ${index + 2}: ${error.message}`);
                        }
                    });

                    // Second pass: Establish parent-child relationships
                    const processedTasks = [];
                    for (const [index, { todo, parentReference }] of taskMap) {
                        if (parentReference && parentReference.toString().trim()) {
                            // Find parent task by title match
                            const parentTask = Array.from(taskMap.values()).find(t => 
                                t.todo.title.toLowerCase().includes(parentReference.toString().toLowerCase().trim())
                            );
                            
                            if (parentTask) {
                                todo.parentId = parentTask.todo.id;
                                parentTask.todo.subtasks.push(todo.id);
                            }
                        }
                        
                        processedTasks.push(todo);
                    }

                    // Add all tasks to the main todos array
                    this.todos.push(...processedTasks);

                    this.saveData();
                    this.renderTodos();
                    this.updateStats();

                    if (importedCount > 0) {
                        this.showNotification(`Successfully imported ${importedCount} tasks from Excel`, 'success');
                        if (errors.length > 0) {
                            console.warn('Import errors:', errors);
                        }
                    } else {
                        this.showNotification('No valid tasks found in Excel file', 'warning');
                    }

                } catch (error) {
                    console.error('Excel processing error:', error);
                    this.showNotification('Error processing Excel file', 'error');
                }
            }

            detectColumns(headers) {
                const columnMap = {
                    title: -1,
                    category: -1,
                    priority: -1,
                    dueDate: -1,
                    status: -1,
                    parent: -1
                };

                headers.forEach((header, index) => {
                    const h = header.toLowerCase();
                    
                    // Title/Task detection
                    if ((h.includes('title') || h.includes('task') || h.includes('name') || 
                        h.includes('description') || h === 'todo') && columnMap.title === -1) {
                        columnMap.title = index;
                    }
                    
                    // Category detection
                    if ((h.includes('category') || h.includes('type') || h.includes('group')) && columnMap.category === -1) {
                        columnMap.category = index;
                    }
                    
                    // Priority detection
                    if ((h.includes('priority') || h.includes('importance') || h.includes('urgent')) && columnMap.priority === -1) {
                        columnMap.priority = index;
                    }
                    
                    // Due date detection
                    if ((h.includes('due') || h.includes('date') || h.includes('deadline') || 
                        h.includes('target')) && columnMap.dueDate === -1) {
                        columnMap.dueDate = index;
                    }
                    
                    // Status detection
                    if ((h.includes('status') || h.includes('complete') || h.includes('done') || 
                        h.includes('finished')) && columnMap.status === -1) {
                        columnMap.status = index;
                    }
                    
                    // Parent task detection
                    if ((h.includes('parent') || h.includes('main') || h.includes('belongs') || 
                        h.includes('under') || h.includes('subtask')) && columnMap.parent === -1) {
                        columnMap.parent = index;
                    }
                });

                return columnMap;
            }

            normalizeCategory(value) {
                if (!value) return 'other';
                const cat = value.toString().toLowerCase().trim();
                const categoryMap = {
                    'work': ['work', 'job', 'office', 'business', 'professional'],
                    'personal': ['personal', 'home', 'family', 'self'],
                    'shopping': ['shopping', 'shop', 'buy', 'purchase', 'grocery'],
                    'health': ['health', 'medical', 'doctor', 'fitness', 'exercise']
                };
                
                for (const [key, synonyms] of Object.entries(categoryMap)) {
                    if (synonyms.some(synonym => cat.includes(synonym))) {
                        return key;
                    }
                }
                return 'other';
            }

            normalizePriority(value) {
                if (!value) return 'medium';
                const priority = value.toString().toLowerCase().trim();
                
                if (priority.includes('high') || priority.includes('urgent') || priority.includes('critical') || priority === '3') {
                    return 'high';
                } else if (priority.includes('low') || priority.includes('minor') || priority === '1') {
                    return 'low';
                }
                return 'medium';
            }

            parseDate(value) {
                if (!value) return '';
                try {
                    const date = new Date(value);
                    if (isNaN(date.getTime())) return '';
                    return date.toISOString().split('T')[0];
                } catch {
                    return '';
                }
            }

            parseStatus(value) {
                if (!value) return false;
                const status = value.toString().toLowerCase().trim();
                return status.includes('complete') || status.includes('done') || 
                       status.includes('finished') || status === 'true' || status === '1';
            }

            addTodo() {
                const title = document.getElementById('task-title').value.trim();
                const category = document.getElementById('task-category').value;
                const priority = document.getElementById('task-priority').value;
                const dueDate = document.getElementById('task-due-date').value;

                if (!title) {
                    this.showNotification('Please enter a task title', 'error');
                    return;
                }

                const todo = {
                    id: this.generateId(),
                    title,
                    category,
                    priority,
                    dueDate,
                    completed: false,
                    parentId: null,
                    subtasks: [],
                    isExpanded: true,
                    createdAt: new Date().toISOString()
                };

                this.todos.push(todo);
                this.saveData();
                this.renderTodos();
                this.updateStats();
                this.clearForm();
                this.showNotification('Task added successfully', 'success');

                // Sync if enabled
                if (this.envConfig.canSync) {
                    this.syncData();
                }
            }

            addSubtask(parentId) {
                const subtaskTitle = prompt('Enter subtask title:');
                if (!subtaskTitle || !subtaskTitle.trim()) {
                    return;
                }

                const parentTask = this.todos.find(t => t.id === parentId);
                if (!parentTask) {
                    this.showNotification('Parent task not found', 'error');
                    return;
                }

                const subtask = {
                    id: this.generateId(),
                    title: subtaskTitle.trim(),
                    category: parentTask.category,
                    priority: parentTask.priority,
                    dueDate: parentTask.dueDate,
                    completed: false,
                    parentId: parentId,
                    subtasks: [],
                    isExpanded: true,
                    createdAt: new Date().toISOString()
                };

                this.todos.push(subtask);
                parentTask.subtasks.push(subtask.id);
                
                this.saveData();
                this.renderTodos();
                this.updateStats();
                this.showNotification('Subtask added successfully', 'success');

                if (this.envConfig.canSync) {
                    this.syncData();
                }
            }

            addAdvancedSubtask(parentId, title, priority, dueDate) {
                const parentTask = this.todos.find(t => t.id === parentId);
                if (!parentTask) {
                    this.showNotification('Parent task not found', 'error');
                    return;
                }

                const subtask = {
                    id: this.generateId(),
                    title: title.trim(),
                    category: parentTask.category,
                    priority: priority,
                    dueDate: dueDate || parentTask.dueDate,
                    completed: false,
                    parentId: parentId,
                    subtasks: [],
                    isExpanded: true,
                    createdAt: new Date().toISOString()
                };

                this.todos.push(subtask);
                parentTask.subtasks.push(subtask.id);
                
                this.saveData();
                this.renderTodos();
                this.updateStats();
                this.showNotification('Subtask added successfully', 'success');

                if (this.envConfig.canSync) {
                    this.syncData();
                }
            }

            toggleExpanded(taskId) {
                const task = this.todos.find(t => t.id === taskId);
                if (task) {
                    task.isExpanded = !task.isExpanded;
                    this.saveData();
                    this.renderTodos();
                }
            }

            clearForm() {
                document.getElementById('task-title').value = '';
                document.getElementById('task-category').value = 'work';
                document.getElementById('task-priority').value = 'medium';
                document.getElementById('task-due-date').value = '';
            }

            toggleComplete(id) {
                const todo = this.todos.find(t => t.id === id);
                if (todo) {
                    todo.completed = !todo.completed;
                    todo.completedAt = todo.completed ? new Date().toISOString() : null;
                    
                    // Auto-complete/uncomplete subtasks
                    if (todo.subtasks && todo.subtasks.length > 0) {
                        todo.subtasks.forEach(subtaskId => {
                            const subtask = this.todos.find(t => t.id === subtaskId);
                            if (subtask) {
                                subtask.completed = todo.completed;
                                subtask.completedAt = todo.completed ? new Date().toISOString() : null;
                            }
                        });
                    }
                    
                    // Check if parent should be auto-completed
                    if (todo.parentId) {
                        const parentTask = this.todos.find(t => t.id === todo.parentId);
                        if (parentTask) {
                            const allSubtasksCompleted = parentTask.subtasks.every(subtaskId => {
                                const subtask = this.todos.find(t => t.id === subtaskId);
                                return subtask ? subtask.completed : false;
                            });
                            
                            if (allSubtasksCompleted && parentTask.subtasks.length > 0) {
                                parentTask.completed = true;
                                parentTask.completedAt = new Date().toISOString();
                            } else if (!todo.completed) {
                                parentTask.completed = false;
                                parentTask.completedAt = null;
                            }
                        }
                    }
                    
                    this.saveData();
                    this.renderTodos();
                    this.updateStats();
                    
                    if (this.envConfig.canSync) {
                        this.syncData();
                    }
                }
            }

            editTodo(id) {
                const todo = this.todos.find(t => t.id === id);
                if (todo) {
                    const newTitle = prompt('Edit task title:', todo.title);
                    if (newTitle && newTitle.trim()) {
                        todo.title = newTitle.trim();
                        todo.updatedAt = new Date().toISOString();
                        this.saveData();
                        this.renderTodos();
                        this.showNotification('Task updated successfully', 'success');
                        
                        if (this.envConfig.canSync) {
                            this.syncData();
                        }
                    }
                }
            }

            deleteTodo(id) {
                if (confirm('Are you sure you want to delete this task? This will also delete all subtasks.')) {
                    const task = this.todos.find(t => t.id === id);
                    if (task) {
                        // Remove all subtasks recursively
                        const toDelete = [id];
                        const collectSubtasks = (taskId) => {
                            const currentTask = this.todos.find(t => t.id === taskId);
                            if (currentTask && currentTask.subtasks) {
                                currentTask.subtasks.forEach(subtaskId => {
                                    toDelete.push(subtaskId);
                                    collectSubtasks(subtaskId);
                                });
                            }
                        };
                        collectSubtasks(id);
                        
                        // Remove from parent's subtask list if it's a subtask
                        if (task.parentId) {
                            const parent = this.todos.find(t => t.id === task.parentId);
                            if (parent) {
                                parent.subtasks = parent.subtasks.filter(sid => sid !== id);
                            }
                        }
                        
                        // Remove all collected tasks
                        this.todos = this.todos.filter(t => !toDelete.includes(t.id));
                    }
                    
                    this.saveData();
                    this.renderTodos();
                    this.updateStats();
                    this.showNotification('Task deleted successfully', 'success');
                    
                    if (this.envConfig.canSync) {
                        this.syncData();
                    }
                }
            }

            renderTodos() {
                const container = document.getElementById('todos-list');
                const filteredTodos = this.getFilteredTodos();

                if (filteredTodos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>No tasks found</h3>
                            <p>${this.filter === 'all' ? 'Add your first task or upload an Excel file to get started' : `No ${this.filter} tasks found`}</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.renderTaskTree(filteredTodos);
            }

            renderTaskTree(todos) {
                // Get only parent tasks (no parentId) for the main level
                const parentTasks = todos.filter(t => !t.parentId);
                
                return parentTasks.map(todo => this.renderTask(todo, todos, 0)).join('');
            }

            renderTask(todo, allTodos, level = 0) {
                const subtasks = todo.subtasks ? todo.subtasks.map(id => 
                    allTodos.find(t => t.id === id)).filter(Boolean) : [];
                
                const hasSubtasks = subtasks.length > 0;
                const indentClass = level > 0 ? `subtask-level-${Math.min(level, 3)}` : '';
                
                // Calculate progress for parent tasks
                let progressInfo = '';
                if (hasSubtasks && level === 0) {
                    const completedSubtasks = subtasks.filter(st => st.completed).length;
                    const progressPercent = (completedSubtasks / subtasks.length) * 100;
                    progressInfo = `
                        <div class="parent-progress">
                            <div class="parent-progress-bar" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="parent-progress-text">${completedSubtasks}/${subtasks.length} subtasks completed</div>
                    `;
                }
                
                let html = `
                    <div class="todo-item ${todo.completed ? 'completed' : ''} ${todo.priority}-priority ${indentClass}" 
                         data-level="${level}" data-task-id="${todo.id}">
                        <div class="todo-header">
                            <div class="todo-title-container">
                                ${hasSubtasks ? `
                                    <button class="expand-btn" onclick="app.toggleExpanded('${todo.id}')" title="${todo.isExpanded ? 'Collapse' : 'Expand'} subtasks">
                                        <i class="fas fa-chevron-${todo.isExpanded ? 'down' : 'right'}"></i>
                                    </button>
                                ` : '<span class="expand-spacer"></span>'}
                                <div class="todo-title">${this.escapeHtml(todo.title)}</div>
                                ${hasSubtasks ? `<span class="subtask-count">${subtasks.length}</span>` : ''}
                            </div>
                            <div class="todo-actions">
                                ${level < 2 ? `
                                    <button class="todo-action add-subtask" onclick="app.addSubtask('${todo.id}')" title="Add subtask">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                ` : ''}
                                <button class="todo-action complete" onclick="app.toggleComplete('${todo.id}')" title="${todo.completed ? 'Mark as pending' : 'Mark as complete'}">
                                    <i class="fas fa-${todo.completed ? 'undo' : 'check'}"></i>
                                </button>
                                <button class="todo-action edit" onclick="app.editTodo('${todo.id}')" title="Edit task">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="todo-action delete" onclick="app.deleteTodo('${todo.id}')" title="Delete task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="todo-meta">
                            <span class="priority-badge priority-${todo.priority}">
                                ${todo.priority} priority
                            </span>
                            <span class="category-badge">
                                <i class="fas fa-tag"></i> ${todo.category}
                            </span>
                            ${todo.dueDate ? `
                                <span class="due-date ${this.isOverdue(todo.dueDate) && !todo.completed ? 'overdue' : ''}">
                                    <i class="fas fa-calendar"></i> 
                                    ${this.formatDate(todo.dueDate)}
                                </span>
                            ` : ''}
                            ${level > 0 ? `<span class="subtask-indicator"><i class="fas fa-level-up-alt"></i> Subtask</span>` : ''}
                        </div>
                        ${progressInfo}
                    </div>
                `;
                
                // Add subtasks if expanded
                if (hasSubtasks && todo.isExpanded) {
                    html += subtasks.map(subtask => 
                        this.renderTask(subtask, allTodos, level + 1)
                    ).join('');
                }
                
                return html;
            }

            getFilteredTodos() {
                let filtered = [...this.todos];

                switch (this.filter) {
                    case 'pending':
                        filtered = filtered.filter(t => !t.completed);
                        break;
                    case 'completed':
                        filtered = filtered.filter(t => t.completed);
                        break;
                    case 'high':
                        filtered = filtered.filter(t => t.priority === 'high');
                        break;
                    case 'overdue':
                        filtered = filtered.filter(t => !t.completed && this.isOverdue(t.dueDate));
                        break;
                }

                // Sort by priority, then by due date, then by creation date
                return filtered.sort((a, b) => {
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    
                    const priorityOrder = { high: 3, medium: 2, low: 1 };
                    const priorityDiff = priorityOrder[b.priority] - priorityOrder[a.priority];
                    if (priorityDiff !== 0) return priorityDiff;
                    
                    if (a.dueDate && b.dueDate) {
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    }
                    
                    return new Date(b.createdAt) - new Date(a.createdAt);
                });
            }

            updateStats() {
                // Only count parent tasks for main stats
                const parentTasks = this.todos.filter(t => !t.parentId);
                const allTasks = this.todos; // Include subtasks for total count
                
                const total = allTasks.length;
                const completed = allTasks.filter(t => t.completed).length;
                const pending = total - completed;
                const overdue = allTasks.filter(t => !t.completed && this.isOverdue(t.dueDate)).length;

                document.getElementById('total-tasks').textContent = total;
                document.getElementById('completed-tasks').textContent = completed;
                document.getElementById('pending-tasks').textContent = pending;
                document.getElementById('overdue-tasks').textContent = overdue;
            }

            isOverdue(dueDate) {
                if (!dueDate) return false;
                return new Date(dueDate) < new Date().setHours(0, 0, 0, 0);
            }

            formatDate(dateString) {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString();
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            // Authentication methods
            handleAuth(type) {
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;

                if (!email || !password) {
                    this.showNotification('Please enter both email and password', 'error');
                    return;
                }

                if (!this.isValidEmail(email)) {
                    this.showNotification('Please enter a valid email address', 'error');
                    return;
                }

                if (password.length < 6) {
                    this.showNotification('Password must be at least 6 characters long', 'error');
                    return;
                }

                // Simulate authentication (in production, this would be real auth)
                const userData = {
                    email,
                    name: email.split('@')[0],
                    id: this.hashString(email)
                };

                this.currentUser = userData;
                this.saveUserData();
                this.showMainApp();
                this.showNotification(`${type === 'login' ? 'Signed in' : 'Account created'} successfully`, 'success');
            }

            isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            hashString(str) {
                return CryptoJS.MD5(str).toString();
            }

            showMainApp() {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('main-app').classList.add('active');
                
                // Update user info
                document.getElementById('user-name').textContent = `Welcome, ${this.currentUser.name}`;
                document.getElementById('user-avatar').textContent = this.currentUser.name.charAt(0).toUpperCase();
                
                this.loadTodos();
                this.renderTodos();
                this.updateStats();
            }

            logout() {
                if (confirm('Are you sure you want to sign out?')) {
                    this.currentUser = null;
                    this.todos = [];
                    localStorage.removeItem('taskflow_user');
                    localStorage.removeItem('taskflow_todos');
                    
                    document.getElementById('main-app').classList.remove('active');
                    document.getElementById('auth-section').style.display = 'block';
                    
                    // Clear form
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                    
                    this.showNotification('Signed out successfully', 'success');
                }
            }

            // Data persistence
            saveData() {
                if (this.currentUser) {
                    const encryptedData = this.encryptData(JSON.stringify(this.todos));
                    localStorage.setItem(`taskflow_todos_${this.currentUser.id}`, encryptedData);
                }
            }

            saveUserData() {
                if (this.currentUser) {
                    localStorage.setItem('taskflow_user', JSON.stringify(this.currentUser));
                }
            }

            loadUserData() {
                const userData = localStorage.getItem('taskflow_user');
                if (userData) {
                    try {
                        this.currentUser = JSON.parse(userData);
                        this.showMainApp();
                    } catch (error) {
                        console.error('Error loading user data:', error);
                        localStorage.removeItem('taskflow_user');
                    }
                }
            }

            loadTodos() {
                if (this.currentUser) {
                    const encryptedData = localStorage.getItem(`taskflow_todos_${this.currentUser.id}`);
                    if (encryptedData) {
                        try {
                            const decryptedData = this.decryptData(encryptedData);
                            this.todos = JSON.parse(decryptedData) || [];
                        } catch (error) {
                            console.error('Error loading todos:', error);
                            this.todos = [];
                        }
                    }
                }
            }

            encryptData(data) {
                return CryptoJS.AES.encrypt(data, ENV_CONFIG.ENCRYPTION_KEY).toString();
            }

            decryptData(encryptedData) {
                const bytes = CryptoJS.AES.decrypt(encryptedData, ENV_CONFIG.ENCRYPTION_KEY);
                return bytes.toString(CryptoJS.enc.Utf8);
            }

            // Sync functionality
            async syncData() {
                if (!this.envConfig.canSync || !this.currentUser) {
                    return;
                }

                try {
                    this.updateSyncStatus('syncing', 'Syncing...');
                    
                    // In a real implementation, this would sync with Tailscale network
                    // For demo purposes, we'll simulate the sync
                    await this.simulateNetworkSync();
                    
                    this.updateSyncStatus('synced', 'All devices synced');
                } catch (error) {
                    console.error('Sync error:', error);
                    this.updateSyncStatus('error', 'Sync failed');
                }
            }

            async simulateNetworkSync() {
                // Simulate network delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // In production, this would:
                // 1. Send data to Tailscale endpoint
                // 2. Receive updates from other devices
                // 3. Merge changes intelligently
                
                console.log('📡 Simulated sync completed');
            }

            updateSyncStatus(status, message) {
                const syncElement = document.querySelector('.sync-status');
                syncElement.className = `sync-status ${status}`;
                
                const icon = status === 'synced' ? 'fa-check-circle' : 
                           status === 'syncing' ? 'fa-sync-alt fa-spin' : 
                           status === 'offline' ? 'fa-wifi-slash' : 'fa-exclamation-triangle';
                
                syncElement.innerHTML = `
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                `;
            }

            // Notifications
            showNotification(message, type = 'success') {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${type}`;
                notification.classList.add('show');

                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
        }

        // Global functions for onclick handlers
        function handleAuth(type) {
            app.handleAuth(type);
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                app.handleFileUpload(input.files[0]);
            }
        }

        function addTodo() {
            app.addTodo();
        }

        function logout() {
            app.logout();
        }

        // Enhanced subtask modal for better UX
        function showSubtaskModal(parentId) {
            const modal = document.createElement('div');
            modal.className = 'subtask-modal-overlay';
            modal.innerHTML = `
                <div class="subtask-modal">
                    <h3><i class="fas fa-plus-circle"></i> Add Subtask</h3>
                    <form id="subtask-form">
                        <div class="form-group">
                            <label for="subtask-title">Subtask Title</label>
                            <input type="text" id="subtask-title" placeholder="Enter subtask title" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="subtask-priority">Priority</label>
                                <select id="subtask-priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="subtask-due-date">Due Date</label>
                                <input type="date" id="subtask-due-date">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="button" class="btn btn-secondary" onclick="closeSubtaskModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Subtask</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('subtask-title').focus();
            
            // Handle form submission
            document.getElementById('subtask-form').onsubmit = (e) => {
                e.preventDefault();
                const title = document.getElementById('subtask-title').value.trim();
                const priority = document.getElementById('subtask-priority').value;
                const dueDate = document.getElementById('subtask-due-date').value;
                
                if (title) {
                    app.addAdvancedSubtask(parentId, title, priority, dueDate);
                    closeSubtaskModal();
                }
            };
            
            // Close on overlay click
            modal.onclick = (e) => {
                if (e.target === modal) closeSubtaskModal();
            };
        }

        function closeSubtaskModal() {
            const modal = document.querySelector('.subtask-modal-overlay');
            if (modal) {
                modal.remove();
            }
        }

        // Initialize app
        const app = new TodoApp();

        // Service Worker for offline support (production feature)
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js').catch(console.error);
        }
    </script>
</body>
</html>